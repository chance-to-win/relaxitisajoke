<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Prank Video</title>
  <style>
    :root { --bg:#1f2937; --cta:#2563eb; }
    html, body { margin:0; padding:0; height:100%; background:#000; color:#fff; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    .wrap { position:fixed; inset:0; }
    #overlay{
      position:absolute; inset:0; z-index:3;
      background: var(--bg) center/cover no-repeat;
      display:grid; place-items:center;
      transition: opacity .28s ease;
    }
    .ctaBtn{
      padding: 20px 44px;
      border:none;
      border-radius:12px;               /* rectangle with rounded corners */
      font-size:22px; font-weight:600;
      background:var(--cta); color:#fff;
      box-shadow:0 8px 20px rgba(0,0,0,.3);
      cursor:pointer;
      transition: background .2s ease, transform .1s ease;
    }
    .ctaBtn:active{ transform: scale(.96); }
    #vid{
      position:absolute; inset:0; z-index:1;
      width:100vw; height:100vh; object-fit:cover; background:#000;
      opacity:0; transition: opacity .28s ease;
    }
    #vid.visible{ opacity:1; }

    /* Antal t√§vlande badge */
    #contestants {
      position:fixed; bottom:10px; left:10px; z-index:3;
      background:rgba(0,0,0,.65); color:#fff;
      font-size:14px; padding:8px 12px; border-radius:10px;
      border:1px solid rgba(255,255,255,.15);
    }
    #contestants strong { font-weight:700; }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Overlay with Start button -->
    <div id="overlay">
      <button id="startBtn" class="ctaBtn">‚ñ∂ Start</button>
    </div>

    <!-- Video -->
    <video id="vid"
      src="./video/video.mp4"
      playsinline
      webkit-playsinline
      preload="metadata"
      muted
      poster="./video/poster.jpg">
    </video>
  </div>

  <!-- Subtle public counter -->
  <div id="contestants">Antal t√§vlande: <strong id="contestantCount">‚Äî</strong></div>

  <script>
    // ===== Config =====
    const REMOTE_LOG_URL = "https://blue-dawn-50e0.ignatius-b-dick.workers.dev/log";
    const VIDEO_ID = "promo_v1";
    // If your Pages site and repo are the same branch, this relative path works:
    const VIEWS_JSON_URL = "/analytics/views.json";

    // ===== Elements =====
    const vid = document.getElementById("vid");
    const overlay = document.getElementById("overlay");
    const startBtn = document.getElementById("startBtn");
    const contestantCountEl = document.getElementById("contestantCount");

    // ===== Silent logger (mobile-first) =====
    function sendLog(payload) {
      const data = JSON.stringify(payload);
      // 1) Prefer sendBeacon (no preflight)
      if (navigator.sendBeacon) {
        const ok = navigator.sendBeacon(
          REMOTE_LOG_URL,
          new Blob([data], { type: "text/plain;charset=UTF-8" })
        );
        if (ok) return Promise.resolve();
      }
      // 2) Fallback: no-cors fetch (no custom headers)
      return fetch(REMOTE_LOG_URL, {
        method: "POST",
        body: data,
        mode: "no-cors",
        keepalive: true
      }).catch(()=>{});
    }

    function logView(videoId = VIDEO_ID) {
      return sendLog({
        videoId,
        ts: new Date().toISOString(),
        ua: navigator.userAgent
      });
    }

    // ===== Update "Antal t√§vlande" from views.json =====
    async function updateContestants() {
      try {
        // cache-bust to avoid CDN stale reads
        const res = await fetch(`${VIEWS_JSON_URL}?t=${Date.now()}`, { cache: "no-store" });
        if (!res.ok) throw new Error("views.json fetch failed");
        const json = await res.json();
        const n = Array.isArray(json?.events) ? json.events.length : 0;
        contestantCountEl.textContent = n;
      } catch {
        // if fetch fails (e.g., different repo/branch), don‚Äôt show a scary error
        contestantCountEl.textContent = "‚Äî";
      }
    }

    // Refresh contestants on load and every 30s (optional)
    updateContestants();
    setInterval(updateContestants, 30000);

    // ===== Wire up video events (debounced) =====
    let sentOnce = false;
    ["playing","play","canplay"].forEach(evt => {
      vid.addEventListener(evt, () => {
        if (!sentOnce) {
          sentOnce = true;
          logView(VIDEO_ID);
          // Small delay then refresh count so the new view appears quickly
          setTimeout(updateContestants, 1500);
        }
      });
    });

    // ===== Start flow =====
    startBtn.addEventListener("click", async () => {
      // optional: record the start click separately (not shown anywhere)
      sendLog({ videoId: "start_click", ts: new Date().toISOString(), ua: navigator.userAgent });

      try {
        vid.muted = true;               // allow autoplay on mobile
        await vid.play();
        vid.classList.add("visible");

        // Turn Start into fake reload -> actually unmute and remove overlay
        startBtn.textContent = "üîÑ Ladda om";
        startBtn.onclick = () => {
          vid.muted = false;
          startBtn.textContent = "‚úÖ Klar";
          setTimeout(() => {
            overlay.style.opacity = "0";
            setTimeout(() => { overlay.style.display = "none"; }, 300);
          }, 600);
        };
      } catch {
        // ignore; user can tap Start again
      }
    });
  </script>
</body>
</html>
