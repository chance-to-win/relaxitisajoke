<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Prank Video</title>
  <style>
    :root { --bg:#1f2937; --cta:#2563eb; }
    html, body { margin:0; padding:0; height:100%; background:#000; color:#fff; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    .wrap { position:fixed; inset:0; }
    #overlay{
      position:absolute; inset:0; z-index:3;
      background: var(--bg) center/cover no-repeat;
      display:grid; place-items:center;
      transition: opacity .28s ease;
    }
    .ctaBtn{
      padding: 20px 44px;
      border:none;
      border-radius:12px;              /* rectangle with rounded corners */
      font-size:22px; font-weight:600;
      background:var(--cta); color:#fff;
      box-shadow:0 8px 20px rgba(0,0,0,.3);
      cursor:pointer;
      transition: background .2s ease, transform .1s ease;
    }
    .ctaBtn:active{ transform: scale(.96); }
    #vid{
      position:absolute; inset:0; z-index:1;
      width:100vw; height:100vh; object-fit:cover; background:#000;
      opacity:0; transition: opacity .28s ease;
    }
    #vid.visible{ opacity:1; }

    /* Visible log counter */
    #logStatus{
      position:fixed; bottom:10px; left:10px; z-index:9999;
      background:rgba(0,0,0,.65); color:#0f0; font-family:monospace;
      font-size:13px; padding:6px 10px; border-radius:6px; user-select:none;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Overlay with Start button -->
    <div id="overlay">
      <button id="startBtn" class="ctaBtn">â–¶ Starta</button>
    </div>

    <!-- Video -->
    <video id="vid"
      src="./video/video.mp4"
      playsinline
      webkit-playsinline
      preload="metadata"
      muted
      poster="./video/poster.jpg">
    </video>
  </div>

  <!-- Visible log badge -->
  <div id="logStatus">Logs: 0</div>

 <script>
  // ===== Config =====
  const REMOTE_LOG_URL = "https://blue-dawn-50e0.ignatius-b-dick.workers.dev/log";
  const VIDEO_ID = "promo_v1";

  // ===== Elements =====
  const vid = document.getElementById("vid");
  const overlay = document.getElementById("overlay");
  const startBtn = document.getElementById("startBtn");
  const statusBox = document.getElementById("logStatus");

  // ===== Visible counter =====
  let logCount = 0;
  function bumpBadge(label){
    logCount++;
    if (statusBox) statusBox.textContent = `Logs: ${logCount} (${label || ""})`;
  }

  // ===== Robust logger (mobile-first) =====
  function sendLog(payload) {
    try { bumpBadge(payload.videoId || "n/a"); } catch {}
    const data = JSON.stringify(payload);

    // 1) Best: sendBeacon (no CORS, very reliable on mobile)
    if (navigator.sendBeacon) {
      const ok = navigator.sendBeacon(
        REMOTE_LOG_URL,
        new Blob([data], { type: "text/plain;charset=UTF-8" }) // avoid JSON preflight
      );
      if (ok) return Promise.resolve("beacon");
    }

    // 2) Fallback: fetch with no-cors and NO custom headers (no preflight)
    return fetch(REMOTE_LOG_URL, {
      method: "POST",
      body: data,
      mode: "no-cors",
      keepalive: true
    }).catch(()=>{ /* ignore */ });
  }

  function logView(videoId = VIDEO_ID) {
    return sendLog({
      videoId,
      ts: new Date().toISOString(),
      ua: navigator.userAgent
    });
  }

  // ===== Wire up video events (debounced) =====
  let sentOnce = false;
  ["playing","play","canplay"].forEach(evt => {
    vid.addEventListener(evt, () => {
      if (!sentOnce) {
        sentOnce = true;
        logView(VIDEO_ID);
      }
    });
  });

  // ===== Start flow =====
  startBtn.addEventListener("click", async () => {
    // immediate test log so you can see it in CF
    sendLog({ videoId: "start_click", ts: new Date().toISOString(), ua: navigator.userAgent });

    try {
      vid.muted = true;               // allow autoplay on mobile
      await vid.play();
      vid.classList.add("visible");

      // turn Start into fake reload that unmutes & hides overlay
      startBtn.textContent = "ðŸ”„ Ladda om";
      startBtn.onclick = () => {
        vid.muted = false;
        startBtn.textContent = "âœ… Klar";
        setTimeout(() => {
          overlay.style.opacity = "0";
          setTimeout(() => { overlay.style.display = "none"; }, 300);
        }, 600);
      };
    } catch (e) {
      // ignore; phone will still show Start to retry
      console.error("Playback blocked", e);
    }
  });

  // Optional: manual tester in console
  window.__testLog = () => sendLog({ videoId: "manual_test", ts: new Date().toISOString(), ua: navigator.userAgent });
</script>

</body>
</html>
